"""
Item system for Telegram RPG Bot "–õ–µ–≥–µ–Ω–¥–∏ –í–∞–ª–≥–∞–ª–ª—ñ—ó"
Contains item classes and item management
"""

import logging
import json
from typing import Dict, List, Any, Optional
from enum import Enum
from dataclasses import dataclass, field
from pathlib import Path

logger = logging.getLogger(__name__)


class ItemType(Enum):
    """Item type enumeration"""
    WEAPON = "weapon"
    ARMOR = "armor"
    CONSUMABLE = "consumable"
    QUEST = "quest"
    ACCESSORY = "accessory"


class ItemRarity(Enum):
    """Item rarity levels"""
    COMMON = "common"
    UNCOMMON = "uncommon"
    RARE = "rare"
    EPIC = "epic"
    LEGENDARY = "legendary"


@dataclass
class Item:
    """Item data class"""
    item_id: str
    name: str
    description: str
    item_type: ItemType
    rarity: ItemRarity = ItemRarity.COMMON
    price: int = 0
    level_required: int = 1
    stats: Dict[str, int] = field(default_factory=dict)
    effects: Dict[str, Any] = field(default_factory=dict)
    stackable: bool = False
    max_stack: int = 1
    consumable_effects: Dict[str, int] = field(default_factory=dict)
    
    def get_stat_bonus(self, stat_name: str) -> int:
        """Get stat bonus from item"""
        return self.stats.get(stat_name, 0)
    
    def get_display_stats(self) -> str:
        """Get formatted stat display"""
        if not self.stats:
            return ""
        
        stat_strings = []
        stat_icons = {
            'attack': '‚öîÔ∏è',
            'defense': 'üõ°',
            'magic_power': 'üîÆ',
            'health': 'üíö',
            'mana': 'üíô',
            'speed': '‚ö°',
            'critical_chance': 'üí•',
            'block_chance': 'üõ°Ô∏è'
        }
        
        for stat, value in self.stats.items():
            if value > 0:
                icon = stat_icons.get(stat, 'üìä')
                stat_strings.append(f"{icon} +{value}")
        
        return " | ".join(stat_strings)
    
    def get_rarity_emoji(self) -> str:
        """Get emoji for item rarity"""
        rarity_emojis = {
            ItemRarity.COMMON: "‚ö™",
            ItemRarity.UNCOMMON: "üü¢",
            ItemRarity.RARE: "üîµ",
            ItemRarity.EPIC: "üü£",
            ItemRarity.LEGENDARY: "üü°"
        }
        return rarity_emojis.get(self.rarity, "‚ö™")
    
    def can_use(self, character_level: int) -> bool:
        """Check if character can use this item"""
        return character_level >= self.level_required
    
    def to_dict(self) -> Dict[str, Any]:
        """Convert to dictionary for storage"""
        return {
            'item_id': self.item_id,
            'name': self.name,
            'description': self.description,
            'item_type': self.item_type.value,
            'rarity': self.rarity.value,
            'price': self.price,
            'level_required': self.level_required,
            'stats': self.stats,
            'effects': self.effects,
            'stackable': self.stackable,
            'max_stack': self.max_stack,
            'consumable_effects': self.consumable_effects
        }


class ItemManager:
    """Manage all game items"""
    
    def __init__(self):
        self.items: Dict[str, Item] = {}
        self.weapons: Dict[str, Item] = {}
        self.armor: Dict[str, Item] = {}
        self.consumables: Dict[str, Item] = {}
        self.accessories: Dict[str, Item] = {}
        self._initialize_items()
    
    def _initialize_items(self):
        """Initialize all game items"""
        # Load from JSON files if they exist, otherwise create defaults
        try:
            self.load_items_from_file()
        except (FileNotFoundError, json.JSONDecodeError):
            logger.info("Creating default item catalog...")
            self._create_default_items()
            self.save_items_to_file()
    
    def _create_default_items(self):
        """Create default item catalog"""
        
        # === WEAPONS ===
        weapons_data = [
            # Common weapons
            Item("basic_sword", "–î–µ—Ä–µ–≤'—è–Ω–∏–π –º–µ—á", "–ü—Ä–æ—Å—Ç–∏–π —Ç—Ä–µ–Ω—É–≤–∞–ª—å–Ω–∏–π –º–µ—á", ItemType.WEAPON, ItemRarity.COMMON, 25, 1, {'attack': 5}),
            Item("iron_sword", "–ó–∞–ª—ñ–∑–Ω–∏–π –º–µ—á", "–ù–∞–¥—ñ–π–Ω–∏–π –∑–∞–ª—ñ–∑–Ω–∏–π –º–µ—á –¥–ª—è –ø–æ—á–∞—Ç–∫—ñ–≤—Ü—ñ–≤", ItemType.WEAPON, ItemRarity.COMMON, 100, 1, {'attack': 15}),
            Item("wooden_staff", "–î–µ—Ä–µ–≤'—è–Ω–∏–π –ø–æ—Å–æ—Ö", "–ü—Ä–æ—Å—Ç–∏–π –º–∞–≥—ñ—á–Ω–∏–π –ø–æ—Å–æ—Ö", ItemType.WEAPON, ItemRarity.COMMON, 80, 1, {'magic_power': 12, 'mana': 20}),
            Item("hunting_bow", "–ú–∏—Å–ª–∏–≤—Å—å–∫–∏–π –ª—É–∫", "–õ–µ–≥–∫–∏–π –ª—É–∫ –¥–ª—è –ø–æ–ª—é–≤–∞–Ω–Ω—è", ItemType.WEAPON, ItemRarity.COMMON, 90, 1, {'attack': 10, 'critical_chance': 5}),
            Item("bronze_dagger", "–ë—Ä–æ–Ω–∑–æ–≤–∏–π –∫–∏–Ω–¥–∂–∞–ª", "–®–≤–∏–¥–∫–∏–π –±—Ä–æ–Ω–∑–æ–≤–∏–π –∫–∏–Ω–¥–∂–∞–ª", ItemType.WEAPON, ItemRarity.COMMON, 60, 1, {'attack': 8, 'speed': 3}),
            
            # Uncommon weapons
            Item("steel_sword", "–°—Ç–∞–ª–µ–≤–∏–π –º–µ—á", "–ú—ñ—Ü–Ω–∏–π —Å—Ç–∞–ª–µ–≤–∏–π –º–µ—á", ItemType.WEAPON, ItemRarity.UNCOMMON, 300, 3, {'attack': 25, 'critical_chance': 5}),
            Item("war_hammer", "–ë–æ–π–æ–≤–∏–π –º–æ–ª–æ—Ç", "–í–∞–∂–∫–∏–π –¥–≤–æ—Ä—É—á–Ω–∏–π –º–æ–ª–æ—Ç", ItemType.WEAPON, ItemRarity.UNCOMMON, 350, 4, {'attack': 35, 'defense': 5}),
            Item("crystal_staff", "–ö—Ä–∏—Å—Ç–∞–ª—ñ—á–Ω–∏–π –ø–æ—Å–æ—Ö", "–ü–æ—Å–æ—Ö –∑ –º–∞–≥—ñ—á–Ω–∏–º –∫—Ä–∏—Å—Ç–∞–ª–æ–º", ItemType.WEAPON, ItemRarity.UNCOMMON, 400, 3, {'magic_power': 30, 'mana': 40}),
            Item("elven_bow", "–ï–ª—å—Ñ—ñ–π—Å—å–∫–∏–π –ª—É–∫", "–í–∏—Ç–æ–Ω—á–µ–Ω–∏–π –µ–ª—å—Ñ—ñ–π—Å—å–∫–∏–π –ª—É–∫", ItemType.WEAPON, ItemRarity.UNCOMMON, 380, 4, {'attack': 20, 'critical_chance': 15, 'speed': 5}),
            Item("poisoned_dagger", "–û—Ç—Ä—É–π–Ω–∏–π –∫–∏–Ω–¥–∂–∞–ª", "–ö–∏–Ω–¥–∂–∞–ª –∑–º–∞—â–µ–Ω–∏–π –æ—Ç—Ä—É—Ç–æ—é", ItemType.WEAPON, ItemRarity.UNCOMMON, 250, 3, {'attack': 18, 'speed': 8}),
            
            # Rare weapons
            Item("flame_sword", "–ü–æ–ª—É–º'—è–Ω–∏–π –º–µ—á", "–ú–µ—á –ø–∞–ª–∞—é—á–∏–π –º–∞–≥—ñ—á–Ω–∏–º –≤–æ–≥–Ω–µ–º", ItemType.WEAPON, ItemRarity.RARE, 800, 6, {'attack': 40, 'magic_power': 15, 'critical_chance': 10}),
            Item("shadow_blade", "–ö–ª–∏–Ω–æ–∫ –¢—ñ–Ω–µ–π", "–ó–∞–≥–∞–¥–∫–æ–≤–∏–π –∫–ª–∏–Ω–æ–∫ –∑ —Ç–µ–º–Ω–æ—ó –º–∞–≥—ñ—ó", ItemType.WEAPON, ItemRarity.RARE, 900, 7, {'attack': 35, 'speed': 15, 'critical_chance': 20}),
            Item("arcane_staff", "–ê—Ä–∫–∞–Ω–Ω–∏–π –ø–æ—Å–æ—Ö", "–ü–æ—Ç—É–∂–Ω–∏–π –º–∞–≥—ñ—á–Ω–∏–π –ø–æ—Å–æ—Ö", ItemType.WEAPON, ItemRarity.RARE, 1200, 8, {'magic_power': 50, 'mana': 80, 'critical_chance': 15}),
            Item("dragon_slayer", "–í–±–∏–≤—Ü—è –î—Ä–∞–∫–æ–Ω—ñ–≤", "–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω–∏–π –º–µ—á –¥–ª—è –±–æ—Ä–æ—Ç—å–±–∏ –∑ –¥—Ä–∞–∫–æ–Ω–∞–º–∏", ItemType.WEAPON, ItemRarity.EPIC, 2500, 15, {'attack': 80, 'defense': 20, 'critical_chance': 25}),
            Item("staff_of_eternity", "–ü–æ—Å–æ—Ö –í—ñ—á–Ω–æ—Å—Ç—ñ", "–ê—Ä—Ç–µ—Ñ–∞–∫—Ç –∑ –±–µ–∑–º–µ–∂–Ω–æ—é –º–∞–≥—ñ—á–Ω–æ—é —Å–∏–ª–æ—é", ItemType.WEAPON, ItemRarity.LEGENDARY, 5000, 20, {'magic_power': 100, 'mana': 200, 'health': 50})
        ]
        
        # === ARMOR ===
        armor_data = [
            # Common armor
            Item("basic_clothes", "–ü—Ä–æ—Å—Ç–∞ –æ–¥–µ–∂–∞", "–ó–≤–∏—á–∞–π–Ω–∏–π –æ–¥—è–≥ –º–∞–Ω–¥—Ä—ñ–≤–Ω–∏–∫–∞", ItemType.ARMOR, ItemRarity.COMMON, 20, 1, {'defense': 2}),
            Item("leather_armor", "–®–∫—ñ—Ä—è–Ω–∞ –±—Ä–æ–Ω—è", "–õ–µ–≥–∫–∞ —Ç–∞ –∑—Ä—É—á–Ω–∞ —à–∫—ñ—Ä—è–Ω–∞ –±—Ä–æ–Ω—è", ItemType.ARMOR, ItemRarity.COMMON, 60, 1, {'defense': 6, 'speed': 2}),
            Item("apprentice_robe", "–†–æ–±–∞ —É—á–Ω—è", "–ü—Ä–æ—Å—Ç–∞ —Ä–æ–±–∞ –¥–ª—è –ø–æ—á–∞—Ç–∫—ñ–≤—Ü—ñ–≤ –º–∞–≥—ñ–≤", ItemType.ARMOR, ItemRarity.COMMON, 70, 1, {'defense': 3, 'mana': 30, 'magic_power': 5}),
            Item("padded_armor", "–°—Ç—å–æ–±–∞–Ω–∞ –±—Ä–æ–Ω—è", "–õ–µ–≥–∫–∞ —Å—Ç—å–æ–±–∞–Ω–∞ –±—Ä–æ–Ω—è", ItemType.ARMOR, ItemRarity.COMMON, 80, 2, {'defense': 8, 'health': 20}),
            Item("scout_vest", "–ñ–∏–ª–µ—Ç —Ä–æ–∑–≤—ñ–¥–Ω–∏–∫–∞", "–õ–µ–≥–∫–∏–π –∂–∏–ª–µ—Ç –¥–ª—è —à–≤–∏–¥–∫–æ–≥–æ –ø–µ—Ä–µ—Å—É–≤–∞–Ω–Ω—è", ItemType.ARMOR, ItemRarity.COMMON, 90, 1, {'defense': 4, 'speed': 8}),
            
            # Uncommon armor
            Item("chainmail", "–ö–æ–ª—å—á—É–≥–∞", "–ù–∞–¥—ñ–π–Ω–∞ –º–µ—Ç–∞–ª–µ–≤–∞ –∫–æ–ª—å—á—É–≥–∞", ItemType.ARMOR, ItemRarity.UNCOMMON, 250, 3, {'defense': 15, 'health': 40}),
            Item("scale_armor", "–õ—É—Å–∫–æ–≤–∞ –±—Ä–æ–Ω—è", "–ë—Ä–æ–Ω—è –∑ –º–µ—Ç–∞–ª–µ–≤–∏—Ö –ª—É—Å–æ–∫", ItemType.ARMOR, ItemRarity.UNCOMMON, 300, 4, {'defense': 18, 'block_chance': 10}),
            Item("mage_robes", "–†–æ–±–∏ –º–∞–≥–∞", "–Ø–∫—ñ—Å–Ω—ñ —Ä–æ–±–∏ –∑ –º–∞–≥—ñ—á–Ω–∏–º–∏ –≤—Å—Ç–∞–≤–∫–∞–º–∏", ItemType.ARMOR, ItemRarity.UNCOMMON, 350, 3, {'defense': 8, 'mana': 70, 'magic_power': 15}),
            Item("ranger_cloak", "–ü–ª–∞—â —Ä–µ–π–Ω–¥–∂–µ—Ä–∞", "–ö–∞–º—É—Ñ–ª—å–æ–≤–∞–Ω–∏–π –ø–ª–∞—â", ItemType.ARMOR, ItemRarity.UNCOMMON, 280, 3, {'defense': 10, 'speed': 12, 'critical_chance': 5}),
            Item("reinforced_leather", "–ü—ñ–¥—Å–∏–ª–µ–Ω–∞ —à–∫—ñ—Ä–∞", "–®–∫—ñ—Ä—è–Ω–∞ –±—Ä–æ–Ω—è –∑ –º–µ—Ç–∞–ª–µ–≤–∏–º–∏ –≤—Å—Ç–∞–≤–∫–∞–º–∏", ItemType.ARMOR, ItemRarity.UNCOMMON, 320, 4, {'defense': 12, 'speed': 5, 'health': 30}),
            
            # Rare armor
            Item("plate_armor", "–õ–∞—Ç–Ω–∞ –±—Ä–æ–Ω—è", "–ü–æ–≤–Ω–∞ –ª–∞—Ç–Ω–∞ –±—Ä–æ–Ω—è –ª–∏—Ü–∞—Ä—è", ItemType.ARMOR, ItemRarity.RARE, 1000, 6, {'defense': 35, 'health': 80, 'block_chance': 20}),
            Item("dragon_scale", "–î—Ä–∞–∫–æ–Ω—è—á–∞ –ª—É—Å–∫–∞", "–ë—Ä–æ–Ω—è –∑ –¥—Ä–∞–∫–æ–Ω—è—á–∏—Ö –ª—É—Å–æ–∫", ItemType.ARMOR, ItemRarity.RARE, 1500, 8, {'defense': 30, 'magic_power': 20, 'health': 100}),
            Item("archmage_robes", "–†–æ–±–∏ –∞—Ä—Ö—ñ–º–∞–≥–∞", "–ï–ª—ñ—Ç–Ω—ñ –º–∞–≥—ñ—á–Ω—ñ —Ä–æ–±–∏", ItemType.ARMOR, ItemRarity.RARE, 1200, 7, {'defense': 15, 'mana': 150, 'magic_power': 35}),
            Item("shadow_cloak", "–ü–ª–∞—â —Ç—ñ–Ω–µ–π", "–¢–∞—î–º–Ω–∏—á–∏–π –ø–ª–∞—â —É–±–∏–≤—Ü—ñ", ItemType.ARMOR, ItemRarity.EPIC, 2000, 12, {'defense': 20, 'speed': 25, 'critical_chance': 20}),
            Item("divine_armor", "–ë–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–∞ –±—Ä–æ–Ω—è", "–ë—Ä–æ–Ω—è –±–ª–∞–≥–æ—Å–ª–æ–≤–ª–µ–Ω–∞ –±–æ–≥–∞–º–∏", ItemType.ARMOR, ItemRarity.LEGENDARY, 4000, 18, {'defense': 60, 'health': 200, 'block_chance': 30})
        ]
        
        # === CONSUMABLES ===
        consumables_data = [
            # Health potions
            Item("small_health_potion", "–ú–∞–ª–µ –∑—ñ–ª–ª—è –∑–¥–æ—Ä–æ–≤'—è", "–í—ñ–¥–Ω–æ–≤–ª—é—î 50 HP", ItemType.CONSUMABLE, ItemRarity.COMMON, 30, 1, {}, {}, True, 10, {'health': 50}),
            Item("health_potion", "–ó—ñ–ª–ª—è –∑–¥–æ—Ä–æ–≤'—è", "–í—ñ–¥–Ω–æ–≤–ª—é—î 100 HP", ItemType.CONSUMABLE, ItemRarity.COMMON, 50, 1, {}, {}, True, 10, {'health': 100}),
            Item("greater_health_potion", "–í–µ–ª–∏–∫–µ –∑—ñ–ª–ª—è –∑–¥–æ—Ä–æ–≤'—è", "–í—ñ–¥–Ω–æ–≤–ª—é—î 200 HP", ItemType.CONSUMABLE, ItemRarity.UNCOMMON, 120, 3, {}, {}, True, 5, {'health': 200}),
            Item("supreme_health_potion", "–ù–∞–π–∫—Ä–∞—â–µ –∑—ñ–ª–ª—è –∑–¥–æ—Ä–æ–≤'—è", "–í—ñ–¥–Ω–æ–≤–ª—é—î 400 HP", ItemType.CONSUMABLE, ItemRarity.RARE, 300, 8, {}, {}, True, 3, {'health': 400}),
            
            # Mana potions
            Item("small_mana_potion", "–ú–∞–ª–µ –∑—ñ–ª–ª—è –º–∞–Ω–∏", "–í—ñ–¥–Ω–æ–≤–ª—é—î 30 –º–∞–Ω–∏", ItemType.CONSUMABLE, ItemRarity.COMMON, 25, 1, {}, {}, True, 10, {'mana': 30}),
            Item("mana_potion", "–ó—ñ–ª–ª—è –º–∞–Ω–∏", "–í—ñ–¥–Ω–æ–≤–ª—é—î 60 –º–∞–Ω–∏", ItemType.CONSUMABLE, ItemRarity.COMMON, 45, 1, {}, {}, True, 10, {'mana': 60}),
            Item("greater_mana_potion", "–í–µ–ª–∏–∫–µ –∑—ñ–ª–ª—è –º–∞–Ω–∏", "–í—ñ–¥–Ω–æ–≤–ª—é—î 120 –º–∞–Ω–∏", ItemType.CONSUMABLE, ItemRarity.UNCOMMON, 100, 3, {}, {}, True, 5, {'mana': 120}),
            
            # Buff potions
            Item("strength_potion", "–ó—ñ–ª–ª—è —Å–∏–ª–∏", "–¢–∏–º—á–∞—Å–æ–≤–æ +10 –¥–æ –∞—Ç–∞–∫–∏ –Ω–∞ 5 –±–æ—ó–≤", ItemType.CONSUMABLE, ItemRarity.UNCOMMON, 80, 2, {}, {}, True, 3, {'temp_attack': 10}),
            Item("defense_potion", "–ó—ñ–ª–ª—è –∑–∞—Ö–∏—Å—Ç—É", "–¢–∏–º—á–∞—Å–æ–≤–æ +8 –¥–æ –∑–∞—Ö–∏—Å—Ç—É –Ω–∞ 5 –±–æ—ó–≤", ItemType.CONSUMABLE, ItemRarity.UNCOMMON, 70, 2, {}, {}, True, 3, {'temp_defense': 8}),
            Item("speed_potion", "–ó—ñ–ª–ª—è —à–≤–∏–¥–∫–æ—Å—Ç—ñ", "–¢–∏–º—á–∞—Å–æ–≤–æ +15 –¥–æ —à–≤–∏–¥–∫–æ—Å—Ç—ñ –Ω–∞ 3 –±–æ—ó", ItemType.CONSUMABLE, ItemRarity.UNCOMMON, 90, 3, {}, {}, True, 3, {'temp_speed': 15}),
            Item("luck_potion", "–ó—ñ–ª–ª—è —É–¥–∞—á—ñ", "–¢–∏–º—á–∞—Å–æ–≤–æ +20% –¥–æ –∫—Ä–∏—Ç–∏—á–Ω–∏—Ö —É–¥–∞—Ä—ñ–≤ –Ω–∞ 3 –±–æ—ó", ItemType.CONSUMABLE, ItemRarity.RARE, 150, 5, {}, {}, True, 2, {'temp_critical': 20}),
            
            # Food and utility
            Item("bread", "–•–ª—ñ–±", "–ü—Ä–æ—Å—Ç–∏–π —Ö–ª—ñ–±, –≤—ñ–¥–Ω–æ–≤–ª—é—î 20 HP", ItemType.CONSUMABLE, ItemRarity.COMMON, 10, 1, {}, {}, True, 20, {'health': 20}),
            Item("cheese", "–°–∏—Ä", "–°–º–∞—á–Ω–∏–π —Å–∏—Ä, –≤—ñ–¥–Ω–æ–≤–ª—é—î 30 HP", ItemType.CONSUMABLE, ItemRarity.COMMON, 15, 1, {}, {}, True, 15, {'health': 30}),
            Item("magic_scroll", "–ú–∞–≥—ñ—á–Ω–∏–π —Å—É–≤—ñ–π", "–í—ñ–¥–Ω–æ–≤–ª—é—î –≤—Å—é –º–∞–Ω—É", ItemType.CONSUMABLE, ItemRarity.UNCOMMON, 200, 4, {}, {}, True, 3, {'mana_full': True}),
            Item("phoenix_feather", "–ü–µ—Ä–æ —Ñ–µ–Ω—ñ–∫—Å–∞", "–í–æ—Å–∫—Ä–µ—à–∞—î –∑ 50% –∑–¥–æ—Ä–æ–≤'—è", ItemType.CONSUMABLE, ItemRarity.EPIC, 1000, 10, {}, {}, True, 1, {'resurrect': 0.5})
        ]
        
        # Add all items to catalog
        for weapon in weapons_data:
            self.add_item(weapon)
        
        for armor_piece in armor_data:
            self.add_item(armor_piece)
        
        for consumable in consumables_data:
            self.add_item(consumable)
    
    def add_item(self, item: Item):
        """Add item to catalog"""
        self.items[item.item_id] = item
        
        # Categorize by type
        if item.item_type == ItemType.WEAPON:
            self.weapons[item.item_id] = item
        elif item.item_type == ItemType.ARMOR:
            self.armor[item.item_id] = item
        elif item.item_type == ItemType.CONSUMABLE:
            self.consumables[item.item_id] = item
        elif item.item_type == ItemType.ACCESSORY:
            self.accessories[item.item_id] = item
    
    def get_item(self, item_id: str) -> Optional[Item]:
        """Get item by ID"""
        return self.items.get(item_id)
    
    def get_items_by_type(self, item_type: ItemType) -> List[Item]:
        """Get all items of specific type"""
        return [item for item in self.items.values() if item.item_type == item_type]
    
    def get_items_by_rarity(self, rarity: ItemRarity) -> List[Item]:
        """Get all items of specific rarity"""
        return [item for item in self.items.values() if item.rarity == rarity]
    
    def get_weapons(self, min_level: int = 1, max_level: int = 50) -> List[Item]:
        """Get weapons within level range"""
        return [
            weapon for weapon in self.weapons.values()
            if min_level <= weapon.level_required <= max_level
        ]
    
    def get_armor(self, min_level: int = 1, max_level: int = 50) -> List[Item]:
        """Get armor within level range"""
        return [
            armor for armor in self.armor.values()
            if min_level <= armor.level_required <= max_level
        ]
    
    def get_consumables(self) -> List[Item]:
        """Get all consumables"""
        return list(self.consumables.values())
    
    def get_shop_items(self, character_level: int, item_type: Optional[ItemType] = None) -> List[Item]:
        """Get items available in shop for character level"""
        available_items = []
        
        for item in self.items.values():
            # Skip quest items and check level requirements
            if item.item_type == ItemType.QUEST:
                continue
            
            if item.level_required <= character_level + 2:  # Allow slightly higher level items
                if item_type is None or item.item_type == item_type:
                    available_items.append(item)
        
        # Sort by level requirement, then by price
        available_items.sort(key=lambda x: (x.level_required, x.price))
        return available_items
    
    def use_consumable(self, item: Item, character) -> Dict[str, Any]:
        """Use a consumable item and return effects"""
        if item.item_type != ItemType.CONSUMABLE:
            return {'success': False, 'message': "–¶–µ–π –ø—Ä–µ–¥–º–µ—Ç –Ω–µ –º–æ–∂–Ω–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏!"}
        
        if not item.consumable_effects:
            return {'success': False, 'message': "–£ —Ü—å–æ–≥–æ –ø—Ä–µ–¥–º–µ—Ç–∞ –Ω–µ–º–∞—î –µ—Ñ–µ–∫—Ç—ñ–≤!"}
        
        results = {'success': True, 'effects': [], 'message': ""}
        
        # Apply effects
        for effect_type, value in item.consumable_effects.items():
            if effect_type == 'health':
                old_health = character.health
                character.health = min(character.health + value, character.max_health)
                healed = character.health - old_health
                if healed > 0:
                    results['effects'].append(f"üíö –í—ñ–¥–Ω–æ–≤–ª–µ–Ω–æ {healed} –∑–¥–æ—Ä–æ–≤'—è")
            
            elif effect_type == 'mana':
                old_mana = character.mana
                character.mana = min(character.mana + value, character.max_mana)
                restored = character.mana - old_mana
                if restored > 0:
                    results['effects'].append(f"üíô –í—ñ–¥–Ω–æ–≤–ª–µ–Ω–æ {restored} –º–∞–Ω–∏")
            
            elif effect_type == 'mana_full':
                if character.max_mana > 0:
                    character.mana = character.max_mana
                    results['effects'].append(f"üíô –ú–∞–Ω–∞ –ø–æ–≤–Ω—ñ—Å—Ç—é –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–∞!")
            
            elif effect_type == 'resurrect':
                if character.health <= 0:
                    character.health = int(character.max_health * value)
                    results['effects'].append(f"üî• –í–æ—Å–∫—Ä–µ—Å—ñ–Ω–Ω—è! –ó–¥–æ—Ä–æ–≤'—è –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–æ –¥–æ {character.health}")
            
            elif effect_type.startswith('temp_'):
                # Temporary effects would be handled by combat system
                stat_name = effect_type.replace('temp_', '')
                results['effects'].append(f"‚ö° –¢–∏–º—á–∞—Å–æ–≤–∏–π –±–æ–Ω—É—Å: +{value} –¥–æ {stat_name}")
        
        results['message'] = f"üçÉ –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ {item.name}!\n" + "\n".join(results['effects'])
        return results
    
    def load_items_from_file(self):
        """Load items from JSON file with backward compatibility"""
        items_file = Path('data/items.json')
        if items_file.exists():
            with open(items_file, 'r', encoding='utf-8') as f:
                items_data = json.load(f)
            
            for item_id, item_info in items_data.items():
                # Handle old format compatibility
                item_type_str = item_info.get('item_type') or item_info.get('type', 'weapon')
                
                # Convert old format stats to new format
                stats = item_info.get('stats', {})
                if not stats:
                    # Convert old format bonuses
                    if 'attack_bonus' in item_info:
                        stats['attack'] = item_info['attack_bonus']
                    if 'defense_bonus' in item_info:
                        stats['defense'] = item_info['defense_bonus']
                    if 'health_bonus' in item_info and item_type_str == 'consumable':
                        # For old consumables, move health_bonus to consumable_effects
                        pass  # Handle below
                
                # Handle old consumable format
                consumable_effects = item_info.get('consumable_effects', {})
                if not consumable_effects and 'health_bonus' in item_info and item_type_str == 'consumable':
                    consumable_effects['health'] = item_info['health_bonus']
                
                try:
                    item = Item(
                        item_id=item_id,
                        name=item_info['name'],
                        description=item_info.get('description', ''),
                        item_type=ItemType(item_type_str),
                        rarity=ItemRarity(item_info.get('rarity', 'common')),
                        price=item_info.get('price', 0),
                        level_required=item_info.get('level_required', 1),
                        stats=stats,
                        effects=item_info.get('effects', {}),
                        stackable=item_info.get('stackable', item_type_str == 'consumable'),
                        max_stack=item_info.get('max_stack', 10 if item_type_str == 'consumable' else 1),
                        consumable_effects=consumable_effects
                    )
                    self.add_item(item)
                except Exception as e:
                    logger.warning(f"Failed to load item {item_id}: {e}")
                    continue
            
            logger.info(f"Loaded {len(self.items)} items from file")
    
    def save_items_to_file(self):
        """Save items to JSON file"""
        items_file = Path('data/items.json')
        items_file.parent.mkdir(exist_ok=True)
        
        items_data = {}
        for item_id, item in self.items.items():
            items_data[item_id] = item.to_dict()
        
        with open(items_file, 'w', encoding='utf-8') as f:
            json.dump(items_data, f, ensure_ascii=False, indent=2)
        
        logger.info(f"Saved {len(items_data)} items to file")
    
    def get_random_loot(self, min_level: int, max_level: int, loot_type: Optional[ItemType] = None) -> Optional[Item]:
        """Get random item for loot drops"""
        import random
        
        # Filter items by level and type
        possible_items = []
        for item in self.items.values():
            if min_level <= item.level_required <= max_level:
                if loot_type is None or item.item_type == loot_type:
                    if item.item_type != ItemType.QUEST:  # No quest items in random loot
                        possible_items.append(item)
        
        if not possible_items:
            return None
        
        # Weight by rarity (common items more likely)
        rarity_weights = {
            ItemRarity.COMMON: 50,
            ItemRarity.UNCOMMON: 25,
            ItemRarity.RARE: 15,
            ItemRarity.EPIC: 8,
            ItemRarity.LEGENDARY: 2
        }
        
        weighted_items = []
        for item in possible_items:
            weight = rarity_weights.get(item.rarity, 10)
            weighted_items.extend([item] * weight)
        
        return random.choice(weighted_items) if weighted_items else None
    
    def calculate_sell_price(self, item: Item) -> int:
        """Calculate sell price for item (usually 25-40% of buy price)"""
        base_price = item.price
        sell_multiplier = 0.3
        
        # Rare items have better sell value
        if item.rarity == ItemRarity.UNCOMMON:
            sell_multiplier = 0.35
        elif item.rarity == ItemRarity.RARE:
            sell_multiplier = 0.4
        elif item.rarity == ItemRarity.EPIC:
            sell_multiplier = 0.45
        elif item.rarity == ItemRarity.LEGENDARY:
            sell_multiplier = 0.5
        
        return max(1, int(base_price * sell_multiplier))
    
    def get_item_description_full(self, item: Item) -> str:
        """Get full item description with all details"""
        lines = [
            f"{item.get_rarity_emoji()} **{item.name}**",
            f"_{item.description}_",
            ""
        ]
        
        # Stats
        stats_text = item.get_display_stats()
        if stats_text:
            lines.append(f"üìä **–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:** {stats_text}")
        
        # Consumable effects
        if item.consumable_effects:
            effects = []
            for effect, value in item.consumable_effects.items():
                if effect == 'health':
                    effects.append(f"üíö +{value} HP")
                elif effect == 'mana':
                    effects.append(f"üíô +{value} Mana")
                elif effect == 'mana_full':
                    effects.append("üíô –ü–æ–≤–Ω–µ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –º–∞–Ω–∏")
                elif effect == 'resurrect':
                    effects.append(f"üî• –í–æ—Å–∫—Ä–µ—Å—ñ–Ω–Ω—è ({int(value*100)}% HP)")
                elif effect.startswith('temp_'):
                    stat = effect.replace('temp_', '')
                    effects.append(f"‚ö° –¢–∏–º—á–∞—Å–æ–≤–æ +{value} {stat}")
            
            if effects:
                lines.append(f"‚ú® **–ï—Ñ–µ–∫—Ç–∏:** {' | '.join(effects)}")
        
        # Requirements and info
        lines.extend([
            "",
            f"üéØ **–†—ñ–≤–µ–Ω—å:** {item.level_required}",
            f"üí∞ **–¶—ñ–Ω–∞:** {item.price} –∑–æ–ª–æ—Ç–∞",
            f"üè∑ **–†—ñ–¥–∫—ñ—Å—Ç—å:** {item.rarity.value.title()}"
        ])
        
        if item.stackable:
            lines.append(f"üì¶ **–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å:** {item.max_stack}")
        
        return "\n".join(lines)


# Global item manager instance - initialize when needed
# item_manager = ItemManager()  # Moved to lazy initialization
